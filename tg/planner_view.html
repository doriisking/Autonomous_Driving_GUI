<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>GPS-based Navigation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link rel="stylesheet" href="static/leaflet.css" />
  <script src="static/leaflet.js"></script>
  <script src="static/leaflet.rotatedMarker.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }

    .container      { display: flex; flex-direction: row; height: 95%; }
    #mapPane   { flex: 5 0 0; min-width: 0; position: relative; }
        .statusBox { width: 100%; height: 20%;
                     background: rgba(255,255,255,.8);
                     font: 12px/1.3 sans-serif;}
	        #statusText     { margin-top: 2px; font-size: 0.6rem; }
		#plannerText     { font-size: 0.6rem; }
	        #controlText     { font-size: 0.6rem; }
   
        #map       { width: 100%; height: 70%; }
	#buttonBox { width: 100%; height: 10%;}
	    #missionBtn {
	      font-size: 0.6rem;      /* 글자 크기 */
	      padding: 0px 0px;     /* 상하·좌우 여백 */
	      min-width: 70px;       /* 버튼 너비 보장 */
	      height: 40px;           /* 버튼 높이에 맞춤(필요 없으면 삭제) */
	     
	    }
	    #controlBtn {
	      font-size: 0.6rem;      /* 글자 크기 */
	      padding: 0px 0px;     /* 상하·좌우 여백 */
	      min-width: 70px;       /* 버튼 너비 보장 */
	      height: 40px;           /* 버튼 높이에 맞춤(필요 없으면 삭제) */
	    }
	    #calibrateBtn {
	      font-size: 0.6rem;      /* 글자 크기 */
	      padding: 0px 0px;     /* 상하·좌우 여백 */
	      min-width: 70px;       /* 버튼 너비 보장 */
	      height: 40px;           /* 버튼 높이에 맞춤(필요 없으면 삭제) */
	    }

	    /* ───── pathSelect 높이·스타일 맞추기 ───── */
	    #pathSelect {
	      font-size: 0.55rem;    
	      padding: 0px 0px;     /* 상·하 패딩 동일, 좌·우는 약간 줄임 */
	       height: 40px;           /* 버튼 높이에 맞춤(필요 없으면 삭제) */
	       box-sizing: border-box; /* 패딩 포함해 정확한 높이 계산 */
	       vertical-align: middle; /* 인라인 요소 정렬 보정 */
	    } 

    #cameraPane{ flex: 5 0 0; min-width: 0;
                 display: flex; align-items: center; justify-content: center;
                 background: #000; }
        #camView   { width: 100%; max-height: 90%; object-fit: contain; }



  </style>
</head>
<body>

<div class="container">
  <div id="mapPane">
	<!-- 상태·컨트롤 박스 -->
    <div class="statusBox">
	  <div id="statusText">No GPS </div>
	  <div id="plannerText">Waiting for sub-goal publish</div>
	  <div id="controlText">Waiting for control signal</div>
    </div>
  
    <div id="map"></div>
    <div id="buttonBox">
      <button id="missionBtn">Start Mission</button>
      <button id="controlBtn">Real Control</button>
      <button id="calibrateBtn">Calibrate</button>
      <select id="pathSelect"><option disabled selected>경로 선택</option></select>
    </div>  
  </div>
  <div id="cameraPane">
    <img id="camView" src="/camera?fps=3&fmt=webp&q=60" alt="camera stream" />
  </div>


</div>



<script>
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

let live = null;
let live0 = null; // the first waypoint
let live2 = null; // the third waypoint
let live5 = null; // sub-goal
let pathLine = null;
let goalIcon = null;
let startIcon = null;
const arrowIcon = L.icon({ iconUrl: 'static/arrow.svg', iconSize: [16,16], iconAnchor: [8,8] });
const circleIconRed = L.icon({ iconUrl: 'static/circle_red.svg', iconSize: [8,8], iconAnchor: [4,4] });
const circleIconBlue = L.icon({ iconUrl: 'static/circle_blue.svg', iconSize: [8,8], iconAnchor: [4,4] });
const circleIconPurple = L.icon({ iconUrl: 'static/circle_purple.svg', iconSize: [8,8], iconAnchor: [4,4] });


const statusBox = document.querySelector('.statusBox');
const statusText = document.getElementById('statusText');
const plannerText = document.getElementById('plannerText');
const controlText = document.getElementById('controlText');

const missionbtn = document.getElementById('missionbtn');
const controlBtn = document.getElementById('controlBtn');
const calibrateBtn = document.getElementById('calibrateBtn');

const pathSelect = document.getElementById('pathSelect');

fetch('/paths')
  .then(r => r.json())
  .then(paths => {
    pathSelect.innerHTML = ''; // clear default
    if (paths.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = '경로 없음';
      opt.disabled = true;
      opt.selected = true;
      pathSelect.appendChild(opt);
      return;
    }

    paths.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.file;
      opt.textContent = p.file;
      pathSelect.appendChild(opt);
    });
    return fetch('/selected_path');
  })
  .then(r => r?.ok ? r.json() : null)
  .then(data => { if (data) drawPathFromData(data); });

pathSelect.addEventListener('change', () => {
  const file = pathSelect.value;
  fetch(`/set_path?file=${encodeURIComponent(file)}`)
    .then(() => fetch('/selected_path'))
    .then(r => r.json())
    .then(drawPathFromData);
});

function drawPathFromData(path) {
  if (pathLine) map.removeLayer(pathLine);
  if (goalIcon) map.removeLayer(goalIcon);

  if (!path.coords.length) return;

  const latlngs = path.coords.map(c => L.latLng(c[0], c[1]));
  pathLine = L.polyline(latlngs, { color: 'blue', weight: 3 }).addTo(map);
  map.fitBounds(L.latLngBounds(latlngs), { padding: [40, 40] });

  goalIcon = L.marker(latlngs.at(-1), {
      icon: new L.Icon({iconUrl:"static/images/marker-icon-green.png",
			shadowUrl:"static/images/marker-shadow.png",			  
			iconSize:[20,32], iconAnchor:[10,32]})
  }).addTo(map);

}

missionBtn.addEventListener('click', () => {
    fetch('/toggle_mission')
      .then(r => r.json())
      .then(res => {
        // 1️⃣ 버튼 텍스트 변경
        missionBtn.textContent = res.active ? 'End Mission' : 'Start Mission';

        // 2️⃣ 상태 박스 색상 변경
        if (res.active) {
          // mission 활성화 → 투명한 초록색
          statusBox.style.background = 'rgba(0,255,0,0.2)';
          statusBox.style.borderColor = '#0a0';
        } else {
          // mission 비활성화 → 원래 색상 복원
          statusBox.style.background = 'rgba(255,255,255,0.8)';
          statusBox.style.borderColor = '#999';
        }
      })
      .catch(err => {
        console.error('Toggle mission failed:', err);
      });
  });

//missionBtn.addEventListener('click', () => {
//  fetch('/toggle_mission')
//    .then(r => r.json())
//    .then(res => {
//      missionBtn.textContent = res.active ? 'End Mission' : 'Start Mission';
//    });
//});

controlBtn.addEventListener('click', () => {
  fetch('/toggle_control')
    .then(r => r.json())
    .then(res => {
      controlBtn.textContent = res.active ? 'Freeze' : 'Real Control';
    });
});

calibrateBtn.addEventListener('click', () => {
  calibrateBtn.disabled = true;  
  controlBtn.disabled = true;
  missionBtn.disabled = true;
  fetch('/calibrate_heading')
    .then(r => r.json())
    .then(res => {
      calibrateBtn.disabled = false;
      controlBtn.disabled = false;
      missionBtn.disabled = false;
    });
});

const evt = new EventSource('/gps');
evt.onmessage = e => {
  const d = JSON.parse(e.data);
  if (d.lat === null || d.lon === null) {
    statusText.textContent = `No GPS / Heading (global) ${(d.heading??0).toFixed(1)}° / (local) ${(d.heading_odom??0).toFixed(1)}°`;
	  
    if (live) { map.removeLayer(live); live = null; }
    if (live0) { map.removeLayer(live0); live0 = null; }
    if (live2) { map.removeLayer(live2); live2 = null; }	  
    if (live5) { map.removeLayer(live5); live5 = null; }

    return;
  }

  const latlng0 = [d.lat0, d.lon0];
  if (!live0) {
    live0 = L.marker(latlng0, {
      icon: circleIconBlue,
    }).addTo(map);
  } else {
    live0.setLatLng(latlng0);
  }

  const latlng2 = [d.lat2, d.lon2];
  if (!live2) {
    live2 = L.marker(latlng2, {
      icon: circleIconPurple,
    }).addTo(map);
  } else {
    live2.setLatLng(latlng2);
  }

  const latlng5 = [d.lat5, d.lon5];
  if (!live5) {
    live5 = L.marker(latlng5, {
      icon: circleIconRed,
    }).addTo(map);
  } else {
    live5.setLatLng(latlng5);
  }

  const latlng = [d.lat, d.lon];
  if (!live) {
    live = L.marker(latlng, {
      icon: arrowIcon,
      rotationAngle: d.heading || 0,
      rotationOrigin: 'center center'
    }).addTo(map);
  } else {
    live.setLatLng(latlng);
    if (d.heading !== null) live.setRotationAngle(d.heading);
  }
  // current gps position as center
  map.panTo(latlng);

  statusText.textContent =
    `GPS ${d.lat.toFixed(6)}, ${d.lon.toFixed(6)} (${d.hdop.toFixed(2)}) / Heading ${(d.heading??0).toFixed(1)}° (${(d.heading_odom??0).toFixed(1)}°) / ${d.status} / ${d.command}`;

  plannerText.textContent =
    `${d.planner}`;
	
  controlText.textContent =
    `${d.status} / ${d.command}`;

};
</script>
</body>
</html>

